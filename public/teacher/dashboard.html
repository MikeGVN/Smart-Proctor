<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <meta charset="UTF-8">
    <title>Teacher Dashboard - Smart Proctor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/style.css">
    
    <style>
        body { background: #f8f9fa; }
        /* Ẩn body mặc định để xử lý chuyển hướng êm ái */
        body { visibility: hidden; } 

        .teacher-badge {
            background: transparent !important;
            color: #d63384 !important;
            border: 2px solid #d63384;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 30px;
            letter-spacing: 1px;
            margin-left: 12px;
            text-transform: uppercase;
            vertical-align: middle;
            display: inline-block;
        }

        .exam-time-badge {
            font-size: 0.75rem;
            background-color: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 6px;
            display: block;
            margin-top: 4px;
        }
    </style>

    <script>
        if (!sessionStorage.getItem('teacherEmail')) {
            window.location.replace('/teacher/login.html');
        } else {
            window.onload = function() {
                document.body.style.visibility = 'visible';
                loadDashboardData();
            }
        }

        function logout() {
            Swal.fire({
                title: 'Đăng xuất?',
                text: "Bạn muốn kết thúc phiên làm việc?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Đăng xuất',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.clear();
                    window.location.href = '/teacher/login.html';
                }
            });
        }
    </script>
</head>

<body>
    <nav class="glass-header">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="#" class="brand-logo text-decoration-none">
                <i class="fas fa-rocket me-2"></i> Smart Proctor
                <span class="teacher-badge">TEACHER</span>
            </a>
            
            <div class="d-flex align-items-center gap-3">
                <span id="teacher-name" class="fw-bold text-dark d-none d-md-block">Giáo Viên</span>
                
                <button onclick="logout()" class="btn btn-sm btn-outline-danger rounded-pill px-3 fw-bold transition-hover">
                    <i class="fas fa-sign-out-alt me-1"></i> Thoát
                </button>
            </div>
        </div>
    </nav>

    <main class="container my-5" style="min-height: 60vh;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-dark mb-1">Quản Lý Đề Thi</h3>
                <p class="text-muted small mb-0">Danh sách các bài thi đang hoạt động</p>
            </div>
            <a href="create.html" class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold text-decoration-none">
                <i class="fas fa-plus me-2"></i> Tạo Đề Mới
            </a>
        </div>

        <div class="row g-4" id="exam-list">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2 small">Đang tải dữ liệu...</p>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="container text-center">
            <p class="mb-0 text-white-50">Hệ thống quản trị dành cho Giảng viên - IT Talent 2025</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function formatDate(isoString) {
            if (!isoString) return 'Tự do';
            const date = new Date(isoString);
            return date.toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
        }

        function loadDashboardData() {
        const tName = sessionStorage.getItem('teacherName');
        if (tName) document.getElementById('teacher-name').innerText = `GV. ${tName}`;

        fetch('/api/exams')
            .then(res => res.json())
            .then(exams => {
                const list = document.getElementById('exam-list');
                list.innerHTML = '';
                
                if(exams.length === 0) {
                    list.innerHTML = '<div class="col-12 text-center text-muted py-5">Chưa có đề thi nào. <br>Hãy bấm "Tạo Đề Mới" để bắt đầu!</div>';
                    return;
                }

                exams.reverse().forEach(exam => {
                    const startDisplay = formatDate(exam.startTime);
                    const endDisplay = formatDate(exam.endTime);

                    list.innerHTML += `
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100 rounded-4 transition-hover">
                                <div class="card-body p-4 d-flex flex-column">
                                    <div class="d-flex justify-content-between mb-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-light text-primary border px-3 py-2 rounded-pill font-monospace">#${exam.code}</span>
                                            <button class="btn btn-sm btn-outline-secondary border-0" onclick="copyCode('${exam.code}')" title="Sao chép mã">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>

                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v text-secondary"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                                                <li><a class="dropdown-item small" href="create.html?edit=${exam.code}"><i class="fas fa-edit me-2 text-warning"></i>Sửa đề thi</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item small text-danger" href="#" onclick="deleteExam('${exam.code}')"><i class="fas fa-trash-alt me-2"></i>Xóa đề</a></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <h5 class="fw-bold text-dark mb-1 text-truncate">${exam.title}</h5>
                                    
                                    <div class="mb-3 mt-2">
                                        <span class="exam-time-badge"><i class="fas fa-clock me-1 text-success"></i> Mở: ${startDisplay}</span>
                                        <span class="exam-time-badge"><i class="fas fa-times-circle me-1 text-danger"></i> Đóng: ${endDisplay}</span>
                                    </div>

                                    <div class="text-muted small mb-4 d-flex justify-content-between border-top pt-2">
                                        <span><i class="fas fa-list-ol me-1"></i> ${exam.questions ? exam.questions.length : 0} câu</span>
                                        <span><i class="fas fa-hourglass-half me-1"></i> ${exam.duration}p</span>
                                        <span><i class="fas fa-redo me-1"></i> ${ (exam.maxAttempts > 0) ? exam.maxAttempts + ' lần' : 'Vô hạn' }</span>
                                    </div>
                                    
                                    <div class="mt-auto">
                                        <a href="exam-detail.html?code=${exam.code}" class="btn btn-primary w-100 rounded-pill fw-bold shadow-sm">
                                            QUẢN LÝ CHI TIẾT
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
            });
    }

    function deleteExam(code) {
        Swal.fire({
            title: 'Xóa đề thi này?',
            text: "Dữ liệu bài làm của HS cũng có thể bị ảnh hưởng!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Xóa vĩnh viễn'
        }).then(async (result) => {
            if (result.isConfirmed) {
                await fetch(`/api/delete-exam/${code}`, { method: 'DELETE' });
                loadDashboardData();
                Swal.fire('Đã xóa!', '', 'success');
            }
        });
    }

    function copyCode(code) {
        navigator.clipboard.writeText(code);
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 2000,
            didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; }
        });
        Toast.fire({ icon: 'success', title: 'Đã copy: ' + code });
    }
    </script>
</body>
</html>