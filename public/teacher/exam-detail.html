<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <meta charset="UTF-8">
    <title>Chi Tiết Đề Thi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .teacher-badge {
            background: transparent !important;
            color: #d63384 !important;
            border: 2px solid #d63384;
            font-size: 0.7rem; font-weight: 800; padding: 4px 12px;
            border-radius: 30px; letter-spacing: 1px; margin-left: 12px;
            text-transform: uppercase; vertical-align: middle; display: inline-block;
        }
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
    
    <nav class="glass-header">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="dashboard.html" class="brand-logo text-decoration-none">
                <i class="fas fa-rocket me-2"></i> Smart Proctor
                <span class="teacher-badge">CHI TIẾT</span>
            </a>
            
            <div class="d-flex align-items-center gap-3">
                <a href="dashboard.html" class="btn btn-sm btn-light rounded-pill px-3 fw-bold border">
                    <i class="fas fa-arrow-left me-1"></i> Quay lại
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-5 flex-grow-1">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold text-dark mb-1" id="exam-title">Đang tải...</h4>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary px-3 py-2 font-monospace" id="exam-code">CODE</span>
                    <span class="text-muted small">Mã đề thi</span>
                </div>
            </div>
            <div>
                <button onclick="openLiveMonitor()" class="btn btn-outline-danger btn-lg rounded-pill px-4 fw-bold shadow-sm">
                    <i class="fas fa-video me-2"></i> Mở Giám Sát Live
                </button>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card stat-card p-4 text-center">
                    <div class="text-uppercase text-muted fw-bold small mb-2">Tổng Bài Làm</div>
                    <div class="display-5 fw-bold text-dark" id="total-subs">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card p-4 text-center">
                    <div class="text-uppercase text-muted fw-bold small mb-2">Điểm Trung Bình</div>
                    <div class="display-5 fw-bold text-primary" id="avg-score">0.0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card p-4 text-center">
                    <div class="text-uppercase text-muted fw-bold small mb-2">Vi Phạm Ghi Nhận</div>
                    <div class="display-5 fw-bold text-danger" id="total-violations">0</div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-header bg-white p-3 border-bottom">
                <h6 class="fw-bold m-0 text-dark">Danh sách thí sinh đã nộp bài</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Họ Tên</th>
                            <th>MSSV</th>
                            <th>Lớp</th>
                            <th class="text-center">Điểm Số</th>
                            <th>Thời Gian Nộp</th>
                            <th>Trạng Thái / Vi Phạm</th>
                            <th class="text-end pe-4">Kháng Nghị</th> </tr>
                    </thead>
                    <tbody id="result-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="main-footer mt-auto">
        <div class="container text-center">
            <p class="mb-0 text-white-50">Hệ thống quản trị dành cho Giảng viên - IT Talent 2025</p>
        </div>
    </footer>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        document.getElementById('exam-code').innerText = code;

        function openLiveMonitor() {
            window.location.href = `monitor.html?code=${code}`;
        }

        async function loadData() {
            try {
                // 1. Lấy thông tin đề để hiện Title
                const exams = await (await fetch('/api/exams')).json();
                const exam = exams.find(e => e.code === code);
                if(exam) document.getElementById('exam-title').innerText = exam.title;

                // 2. Lấy danh sách kết quả
                const results = await (await fetch(`/api/exam-results/${code}`)).json();
                
                // --- CẬP NHẬT THỐNG KÊ ---
                document.getElementById('total-subs').innerText = results.length;
                // Tính điểm trung bình (chống chia cho 0)
                const avg = results.length ? (results.reduce((a,b)=>a+b.score,0)/results.length).toFixed(2) : "0.0";
                document.getElementById('avg-score').innerText = avg;
                
                let violationCount = 0;
                const tbody = document.getElementById('result-body');
                tbody.innerHTML = '';

                // Nếu chưa có bài làm nào
                if(results.length === 0) {
                    // Colspan = 7 vì bảng giờ có 7 cột
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Chưa có bài làm nào.</td></tr>';
                    return;
                }

                // --- RENDER TỪNG DÒNG ---
                results.forEach(r => {
                    // Xử lý đếm và hiển thị vi phạm
                    const vList = r.violations || [];
                    violationCount += vList.length;

                    let vHtml = vList.length === 0 
                        ? '<span class="badge bg-success bg-opacity-10 text-success border border-success">An toàn</span>'
                        : vList.map(v => `<span class="badge bg-danger bg-opacity-10 text-danger border border-danger me-1" title="${v.time}">${v.type}</span>`).join(' ');

                    // [LOGIC MỚI] XỬ LÝ CỘT KHÁNG NGHỊ
                    let appealHtml = '<span class="text-muted small opacity-50">--</span>';
                    
                    if (r.appeal) {
                        // Xử lý ký tự đặc biệt (nháy đơn/kép) để tránh lỗi JS khi bấm nút
                        const safeReason = (r.appeal.reason || "").replace(/"/g, '&quot;').replace(/'/g, "\\'");
                        const safeTime = new Date(r.appeal.time).toLocaleString('vi-VN');
                        
                        // Nút xem kháng nghị
                        appealHtml = `
                            <button class="btn btn-sm btn-warning fw-bold shadow-sm d-flex align-items-center gap-1 mx-auto px-3" 
                                onclick="showAppeal('${r.studentName}', '${safeReason}', '${safeTime}')">
                                <i class="fas fa-envelope-open-text"></i>
                                <span>Xem</span>
                            </button>
                        `;
                    }

                    // Render HTML cho dòng
                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-4 fw-bold text-dark">${r.studentName}</td>
                            <td>${r.studentId || '--'}</td>
                            <td>${r.studentClass || '--'}</td>
                            <td class="text-center"><span class="fw-bold text-primary fs-6">${r.score}</span></td>
                            <td class="small text-muted">${new Date(r.submittedAt).toLocaleString('vi-VN')}</td>
                            <td>${vHtml}</td>
                            <td class="text-center">${appealHtml}</td> </tr>
                    `;
                });
                
                // Cập nhật tổng số vi phạm lên thẻ thống kê
                document.getElementById('total-violations').innerText = violationCount;

            } catch (err) {
                console.error(err);
                Swal.fire('Lỗi', 'Không thể tải dữ liệu kết quả.', 'error');
            }
        }

        // [HÀM MỚI] Hiển thị chi tiết kháng nghị khi bấm nút
        function showAppeal(name, reason, time) {
            Swal.fire({
                title: `<div class="fs-5 text-start border-bottom pb-2 mb-2"><i class="fas fa-user-graduate me-2"></i>Kháng nghị từ: <b>${name}</b></div>`,
                html: `
                    <div class="text-start">
                        <div class="mb-3 small text-muted">
                            <i class="fas fa-clock me-1"></i> Thời gian gửi: ${time}
                        </div>
                        <label class="fw-bold text-secondary small mb-1">NỘI DUNG GIẢI TRÌNH:</label>
                        <div class="p-3 bg-light rounded border border-warning bg-opacity-10 text-dark fw-bold" 
                            style="font-size: 1rem; line-height: 1.6; white-space: pre-wrap;">${reason}</div>
                    </div>
                `,
                width: 500,
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: '<i class="fas fa-check me-2"></i>Đã Đọc / Đóng',
                confirmButtonColor: '#6c757d'
            });
        }

        // Gọi hàm load dữ liệu khi trang vừa tải
        loadData();
    </script>
</body>
</html>