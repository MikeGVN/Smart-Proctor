<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <meta charset="UTF-8">
    <title>Soạn Thảo Đề Thi - Smart Proctor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/style.css">
    
    <style>
        /* [OVERRIDE] STYLE CHO TRANG CREATE */
        body { background-color: #f8f9fa; padding-bottom: 100px; }
        
        .question-card {
            pointer-events: auto !important; 
            background: white !important;
            border: 1px solid rgba(0,0,0,0.05) !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03) !important;
            transition: transform 0.2s;
        }
        .question-card:hover { transform: translateY(-2px); }

        .form-control, .form-select {
            border-radius: 10px; padding: 10px 15px;
            border: 1px solid #e9ecef; font-size: 0.95rem;
            background-color: #fff;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); border-color: var(--primary);
        }

        /* CONFIG CARD (SIDEBAR) - GIAO DIỆN MỚI */
        .config-card {
            background: white; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .config-header {
            background: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);
            color: white; padding: 15px 20px; font-weight: 700;
        }
        .time-group {
            background: #f8f9fa; border-radius: 12px; padding: 15px;
            border: 1px dashed #dee2e6; position: relative;
        }
        .time-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
            font-weight: 800; margin-bottom: 5px; display: block;
        }

        /* OPTION ROW */
        .option-row {
            display: flex; align-items: center; margin-bottom: 10px;
            border: 1px solid #f1f3f5; border-radius: 8px; padding: 8px 15px;
            background: #fff; transition: 0.2s;
        }
        .option-row:hover { border-color: #dee2e6; background: #f8f9fa; }
        
        .opt-label { font-weight: 700; color: #adb5bd; width: 30px; font-size: 1.1rem; }
        .opt-input { border: none; background: transparent; width: 100%; outline: none; color: #495057; font-weight: 500; }
        .opt-check { width: 22px; height: 22px; cursor: pointer; accent-color: #198754; }
        
        .teacher-badge {
            border: 2px solid #f72585; color: #f72585; font-size: 0.65rem; 
            font-weight: 800; padding: 3px 10px; border-radius: 20px; 
            margin-left: 10px; text-transform: uppercase; vertical-align: middle;
        }
    </style>

    <script>
        if (!sessionStorage.getItem('teacherEmail')) window.location.replace('/teacher/login.html');
    </script>
</head>

<body>
    <nav class="glass-header sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="dashboard.html" class="brand-logo text-decoration-none">
                <i class="fas fa-rocket me-2" style="color: var(--primary)"></i> Smart Proctor
                <span class="teacher-badge">EDITOR</span>
            </a>
            <div class="d-flex align-items-center gap-3">
                <a href="dashboard.html" class="btn btn-sm btn-light border rounded-pill px-3 fw-bold text-secondary">
                    <i class="fas fa-times me-1"></i> Đóng
                </a>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <div class="row g-4">
            <div class="col-lg-4"> 
                <div class="config-card sticky-top" style="top: 90px; z-index: 10;">
                    <div class="config-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-sliders-h me-2"></i>CẤU HÌNH ĐỀ THI</span>
                        <span class="badge bg-white text-primary" id="mode-badge">TẠO MỚI</span>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-secondary">Tên bài thi</label>
                            <input type="text" id="examTitle" class="form-control fw-bold" placeholder="VD: Kiểm tra 15 phút">
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold small text-secondary">Mã đề (Unique)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-hashtag"></i></span>
                                    <input type="text" id="examCode" class="form-control font-monospace fw-bold text-primary" placeholder="AUTO">
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold small text-secondary">Số lần thi ( /người)</label>
                                <div class="input-group">
                                    <input type="number" id="maxAttempts" class="form-control text-center fw-bold" value="1" min="1">
                                    <div class="input-group-text bg-white">
                                        <input class="form-check-input mt-0" type="checkbox" id="unlimitedAttempts" onchange="toggleAttempts()">
                                        <label class="form-check-label ms-2 small text-muted mb-0" for="unlimitedAttempts" style="font-size: 0.8rem;">Vô hạn</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold small text-secondary d-flex justify-content-between">
                                <span>Thời lượng (Phút)</span>
                                <span class="text-primary fw-bold" id="duration-val">45 phút</span>
                            </label>
                            <input type="range" class="form-range" min="5" max="180" step="5" id="examDuration" value="45" oninput="document.getElementById('duration-val').innerText = this.value + ' phút'">
                        </div>

                        <div class="time-group mb-4">
                            <h6 class="fw-bold text-dark mb-3" style="font-size: 0.9rem;"><i class="fas fa-calendar-alt me-2 text-warning"></i>LỊCH TRÌNH MỞ ĐỀ</h6>
                            
                            <div class="mb-3">
                                <span class="time-label text-success"><i class="fas fa-play-circle me-1"></i> Bắt đầu mở</span>
                                <input type="datetime-local" id="startTime" class="form-control border-success border-opacity-25">
                            </div>
                            
                            <div>
                                <span class="time-label text-danger"><i class="fas fa-stop-circle me-1"></i> Kết thúc (Đóng)</span>
                                <input type="datetime-local" id="endTime" class="form-control border-danger border-opacity-25">
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="noLimit" onclick="toggleEndTime()">
                                <label class="form-check-label small text-muted" for="noLimit">Mở tự do (Không giới hạn đóng)</label>
                            </div>
                        </div>

                        <button class="btn btn-primary w-100 py-3 rounded-3 fw-bold shadow-sm animate__animated animate__pulse animate__infinite" onclick="saveExam()">
                            <i class="fas fa-save me-2"></i> <span id="btn-save-text">LƯU ĐỀ THI</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-dark m-0">Nội Dung Câu Hỏi</h5>
                    <span class="badge bg-light text-secondary border rounded-pill px-3">Tổng: <span id="q-total">0</span> câu</span>
                </div>

                <div id="questions-container"></div>

                <div onclick="addQuestion()" class="card border-2 border-dashed border-primary bg-primary bg-opacity-10 text-primary p-3 rounded-4 text-center cursor-pointer hover-scale mt-3" style="cursor: pointer; transition: 0.2s;">
                    <div class="fw-bold"><i class="fas fa-plus-circle fa-2x mb-2"></i><br>THÊM CÂU HỎI MỚI</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let qCount = 0;
        const urlParams = new URLSearchParams(window.location.search);
        const editCode = urlParams.get('edit'); // Lấy mã đề cần sửa từ URL

        // --- 1. KHỞI TẠO (CHECK EDIT MODE) ---
        window.onload = async () => {
            if(editCode) {
                // Chế độ Sửa
                document.getElementById('mode-badge').innerText = "CHỈNH SỬA";
                document.getElementById('mode-badge').className = "badge bg-warning text-dark";
                document.getElementById('btn-save-text').innerText = "CẬP NHẬT ĐỀ THI";
                document.getElementById('examCode').disabled = true; // Không cho sửa mã đề
                
                await loadExamData(editCode);
            } else {
                // Chế độ Tạo mới: Thêm sẵn 1 câu cho đỡ trống
                addQuestion();
            }
        };

        // --- 2. LOGIC LOAD DATA KHI SỬA (ĐÃ CẬP NHẬT) ---
        async function loadExamData(code) {
            try {
                Swal.showLoading();
                const exams = await (await fetch('/api/exams')).json();
                const exam = exams.find(e => e.code === code);
                Swal.close();

                if(!exam) {
                    Swal.fire('Lỗi', 'Không tìm thấy đề thi này!', 'error').then(() => window.location.href='dashboard.html');
                    return;
                }

                // --- FILL DỮ LIỆU CƠ BẢN ---
                document.getElementById('examTitle').value = exam.title;
                document.getElementById('examCode').value = exam.code;
                document.getElementById('examDuration').value = exam.duration;
                document.getElementById('duration-val').innerText = exam.duration + ' phút';

                // --- [MỚI] XỬ LÝ SỐ LẦN THI ---
                // Nếu maxAttempts <= 0 hoặc -1 thì coi là vô hạn
                if (exam.maxAttempts && exam.maxAttempts > 0) {
                    document.getElementById('maxAttempts').value = exam.maxAttempts;
                    document.getElementById('unlimitedAttempts').checked = false;
                    document.getElementById('maxAttempts').disabled = false;
                } else {
                    // Chế độ Vô hạn
                    document.getElementById('unlimitedAttempts').checked = true;
                    document.getElementById('maxAttempts').disabled = true;
                    document.getElementById('maxAttempts').value = ''; // Xóa số để nhìn cho thoáng
                }
                
                // --- XỬ LÝ THỜI GIAN ---
                if(exam.startTime) document.getElementById('startTime').value = new Date(exam.startTime).toISOString().slice(0,16);
                
                if(exam.endTime) {
                    document.getElementById('endTime').value = new Date(exam.endTime).toISOString().slice(0,16);
                    document.getElementById('noLimit').checked = false;
                    document.getElementById('endTime').disabled = false;
                } else {
                    document.getElementById('noLimit').checked = true;
                    document.getElementById('endTime').value = '';
                    document.getElementById('endTime').disabled = true;
                }

                // --- FILL CÂU HỎI ---
                document.getElementById('questions-container').innerHTML = '';
                qCount = 0;
                exam.questions.forEach(q => {
                    addQuestion(q); 
                });

            } catch(e) { console.error(e); Swal.fire('Lỗi', 'Lỗi tải dữ liệu', 'error'); }
        }

        // --- 3. LOGIC GIAO DIỆN ---
        function toggleEndTime() {
            const chk = document.getElementById('noLimit');
            const inp = document.getElementById('endTime');
            if(chk.checked) { inp.value = ''; inp.disabled = true; } 
            else { inp.disabled = false; }
        }

        function addQuestion(data = null) {
            qCount++;
            document.getElementById('q-total').innerText = qCount;
            const qId = `q-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            
            // Nếu có data (khi edit) thì lấy giá trị, không thì để trống
            const content = data ? data.question : '';
            const type = data ? data.type : 'single';

            const html = `
                <div class="card question-card mb-4 rounded-4" id="${qId}">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="badge bg-primary rounded-pill px-3">Câu ${qCount}</span>
                            <button class="btn btn-sm btn-light text-danger rounded-circle" onclick="removeQuestion('${qId}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        
                        <div class="mb-3">
                            <textarea class="form-control fw-bold text-dark q-content" rows="2" placeholder="Nhập nội dung câu hỏi..." style="font-size: 1.05rem;">${content}</textarea>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <select class="form-select w-auto text-secondary q-type shadow-none bg-light border-0" onchange="changeInputType(this, '${qId}')">
                                <option value="single" ${type === 'single' ? 'selected' : ''}>Chọn 1 đáp án (Radio)</option>
                                <option value="multi" ${type === 'multi' ? 'selected' : ''}>Chọn nhiều (Checkbox)</option>
                            </select>
                        </div>

                        <div class="options-group ps-2 border-start border-3 border-light" id="opts-${qId}">
                            </div>

                        <div class="mt-3">
                            <button class="btn btn-sm btn-light text-primary fw-bold rounded-pill border px-3" onclick="addOption('${qId}')">
                                <i class="fas fa-plus me-1"></i> Thêm lựa chọn
                            </button>
                        </div>
                    </div>
                </div>`;
            
            document.getElementById('questions-container').insertAdjacentHTML('beforeend', html);

            // Render Options
            if (data && data.options) {
                // Nếu đang Edit: Render theo data cũ
                Object.keys(data.options).sort().forEach(key => {
                    const val = data.options[key];
                    const isCorrect = data.correct.includes(key);
                    renderOptionRow(qId, key, val, isCorrect, type);
                });
            } else {
                // Nếu tạo mới: Render mặc định 4 ô A,B,C,D trống
                ['A','B','C','D'].forEach(lbl => renderOptionRow(qId, lbl, '', false, 'single'));
            }
        }
        // Hàm bật tắt ô nhập số lần thi
        function toggleAttempts() {
            const chk = document.getElementById('unlimitedAttempts');
            const inp = document.getElementById('maxAttempts');
            if (chk.checked) {
                inp.disabled = true;
                inp.value = ''; // Xóa số cho đỡ rối
            } else {
                inp.disabled = false;
                inp.value = '1';
            }
        }
        function renderOptionRow(qId, label, value, isChecked, type) {
            const container = document.getElementById(`opts-${qId}`);
            const inputType = type === 'single' ? 'radio' : 'checkbox';
            
            const div = document.createElement('div');
            div.className = 'option-row';
            div.id = `row-${qId}-${label}`;
            div.innerHTML = `
                <span class="opt-label">${label}</span>
                <input type="text" class="opt-input q-opt-text" data-label="${label}" value="${value}" placeholder="Nhập đáp án...">
                <input class="opt-check q-correct-input" type="${inputType}" name="correct-${qId}" value="${label}" ${isChecked ? 'checked' : ''}>
                <i class="fas fa-times text-muted ms-3 hover-danger" style="cursor:pointer; font-size: 0.9rem;" onclick="deleteOption(this, '${qId}')"></i>
            `;
            container.appendChild(div);
        }

        function addOption(qId) {
            const container = document.getElementById(`opts-${qId}`);
            const nextChar = String.fromCharCode(65 + container.children.length);
            const typeSelect = document.querySelector(`#${qId} .q-type`);
            renderOptionRow(qId, nextChar, '', false, typeSelect.value);
        }

        function deleteOption(btn, qId) {
            btn.parentElement.remove();
            // Re-index labels A, B, C...
            const container = document.getElementById(`opts-${qId}`);
            Array.from(container.children).forEach((row, idx) => {
                const char = String.fromCharCode(65 + idx);
                row.querySelector('.opt-label').innerText = char;
                row.querySelector('.q-opt-text').dataset.label = char;
                row.querySelector('.q-correct-input').value = char;
            });
        }

        function changeInputType(select, qId) {
            const type = select.value === 'single' ? 'radio' : 'checkbox';
            document.querySelectorAll(`#${qId} .q-correct-input`).forEach(inp => {
                inp.type = type;
                inp.checked = false;
            });
        }

        function removeQuestion(id) {
            document.getElementById(id).remove();
            qCount--;
            document.getElementById('q-total').innerText = qCount;
        }

        // --- 4. SAVE EXAM (ĐÃ CẬP NHẬT LOGIC VÔ HẠN) ---
        async function saveExam() {
            const title = document.getElementById('examTitle').value.trim();
            const code = document.getElementById('examCode').value.trim();
            const duration = document.getElementById('examDuration').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            // --- [MỚI] XỬ LÝ SỐ LẦN THI ---
            let maxAttempts = document.getElementById('maxAttempts').value;
            if (document.getElementById('unlimitedAttempts').checked) {
                maxAttempts = -1; // Quy ước: -1 là không giới hạn
            } else {
                // Nếu người dùng nhập linh tinh hoặc số âm thì mặc định là 1
                if (!maxAttempts || maxAttempts < 1) maxAttempts = 1;
            }

            const qCards = document.querySelectorAll('.question-card');

            if(!title || !code || qCards.length === 0) {
                return Swal.fire('Thiếu thông tin', 'Nhập tên, mã đề và ít nhất 1 câu hỏi.', 'warning');
            }

            let questions = [];
            let isValid = true;
            qCards.forEach(card => {
                const content = card.querySelector('.q-content').value.trim();
                const type = card.querySelector('.q-type').value;
                const optTexts = card.querySelectorAll('.q-opt-text');
                let options = {};
                optTexts.forEach(opt => options[opt.dataset.label] = opt.value.trim());
                
                const correct = [];
                card.querySelectorAll('.q-correct-input:checked').forEach(inp => correct.push(inp.value));

                if (!content || correct.length === 0) isValid = false;
                questions.push({ question: content, type, options, correct, correctCount: correct.length });
            });

            if (!isValid) return Swal.fire('Chưa xong', 'Các câu hỏi phải có nội dung và ĐÁP ÁN ĐÚNG.', 'warning');

            try {
                Swal.showLoading();
                const res = await fetch('/api/create-exam', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    // Gửi maxAttempts đã xử lý (-1 hoặc số dương) lên server
                    body: JSON.stringify({ title, code, duration, maxAttempts, startTime, endTime, questions })
                });
                const data = await res.json();
                Swal.close();
                
                if(data.success) {
                    Swal.fire({ title: 'Thành công!', text: 'Đã lưu đề thi.', icon: 'success' })
                    .then(() => window.location.href = 'dashboard.html');
                } else {
                    Swal.fire('Lỗi', data.msg, 'error');
                }
            } catch (err) { Swal.fire('Lỗi', 'Lỗi kết nối server.', 'error'); }
        }
    </script>
</body>
</html>