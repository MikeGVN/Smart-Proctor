<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <meta charset="UTF-8">
    <title>Kết Quả Bài Thi - Smart Proctor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body { background-color: #f8f9fa; display: flex; flex-direction: column; min-height: 100vh; }
        
        .score-card { 
            max-width: 500px; width: 100%; border: none; 
            border-radius: 20px; overflow: hidden; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            background: white;
            margin: 40px auto;
        }
        
        .card-header-custom { 
            background: linear-gradient(135deg, #4361ee, #3f37c9); 
            padding: 40px 20px; text-align: center; color: white; 
        }
        
        .score-circle { 
            width: 120px; height: 120px; background: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            margin: 0 auto 20px; color: #4361ee; font-weight: 800; font-size: 3rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .score-body { padding: 30px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .info-label { color: #6c757d; font-weight: 600; font-size: 0.9rem; }
        .info-val { color: #212529; font-weight: 700; }

        /* Thêm flex-direction: column để chiều rộng tự động giãn ra 100% */
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        /* Giới hạn chiều cao bảng lịch sử, quá 400px thì hiện thanh cuộn */
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
        }

        /* Giữ cố định cái tiêu đề bảng khi cuộn */
        .table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa; /* Màu nền tiêu đề */
            z-index: 1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <nav class="glass-header">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="index.html" class="brand-logo">
                <i class="fas fa-rocket me-2"></i> Smart Proctor
            </a>
            
            <ul class="nav nav-pills bg-white p-1 rounded-pill border d-none d-md-flex">
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="fas fa-pen-nib me-1"></i> Làm Bài Thi
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active">
                        <i class="fas fa-check-circle me-1"></i> Kết Quả
                    </a>
                </li>
            </ul>

            <a href="/teacher/dashboard.html" class="btn-teacher-login">
                <i class="fas fa-chalkboard-teacher me-2"></i> GV Login
            </a>
        </div>
    </nav>

    <div class="main-content container px-3">
        <div class="row justify-content-center">
            <div class="col-lg-5 mb-4">
                <div class="score-card animate__animated animate__zoomIn">
                    <div class="card-header-custom">
                        <div class="score-circle" id="display-score">--</div>
                        <h4 class="fw-bold m-0 text-uppercase">Kết Quả Mới Nhất</h4>
                        <p class="opacity-75 mb-0 small">Hệ thống chấm điểm tự động</p>
                    </div>
                    <div class="score-body">
                        <div class="info-row">
                            <span class="info-label">Họ và Tên</span>
                            <span class="info-val" id="res-name">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Lớp</span>
                            <span class="info-val" id="res-class">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Mã Số SV</span>
                            <span class="info-val" id="res-id">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Mã Đề Thi</span>
                            <span class="info-val text-primary" id="res-code">...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Thời gian nộp</span>
                            <span class="info-val" id="res-time">...</span>
                        </div>

                        <div class="mt-4 d-grid gap-2">
                            <a href="index.html" class="btn btn-outline-primary fw-bold rounded-pill py-2" onclick="sessionStorage.clear()">
                                <i class="fas fa-home me-2"></i> Về Trang Chủ
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7 mb-4 d-none" id="history-section">
                <div class="card border-0 shadow-sm rounded-4 h-100 animate__animated animate__fadeInRight">
                    <div class="card-header bg-white border-0 pt-4 px-4">
                        <h5 class="fw-bold text-dark"><i class="fas fa-history me-2 text-warning"></i>Lịch Sử Làm Bài</h5>
                        <p class="text-muted small mb-0">Chi tiết các lần thi của thí sinh này</p>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4 py-3">Lần</th>
                                        <th class="py-3">Thời Gian Nộp</th>
                                        <th class="py-3 text-center">Điểm Số</th>
                                        <th class="pe-4 py-3 text-end">Trạng Thái</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="main-footer">
        <div class="container text-center">
            <p class="mb-0 text-white-50 small">&copy; 2025 Smart Proctor Technology - SmartProctor Team</p>
        </div>
    </footer>

    <script>
        // 1. Xử lý khi bấm nút Back/Forward (Lùi/Tiến)
        window.addEventListener('pageshow', function(event) {
            // Luôn luôn chạy lại hàm init để đồng bộ, không quan tâm cache
            initScore(); 
        });

        async function initScore() {
            // Bước 1: Hiển thị tạm cái cũ (để đỡ trắng trang)
            const cachedResult = sessionStorage.getItem('examResult');
            const historyData = sessionStorage.getItem('examHistory');

            if (cachedResult) renderScore(JSON.parse(cachedResult));
            if (historyData) renderHistoryTable(JSON.parse(historyData));

            // Bước 2: Gọi Server lấy cái mới nhất ngay lập tức
            await fetchAndRenderAlways();
        }

        // --- [SỬA LẠI] HÀM NÀY SẼ CẬP NHẬT BẤT CHẤP (KHÔNG CẦN ĐIỀU KIỆN) ---
        async function fetchAndRenderAlways() {
            const sName = sessionStorage.getItem('studentName');
            const sId = sessionStorage.getItem('studentId');
            const examDataRaw = sessionStorage.getItem('examData');
            const examCode = examDataRaw ? JSON.parse(examDataRaw).code : null;

            if (!sName || !examCode) return;

            // Thử liên tục 15 lần (trong 15 giây) để bắt kịp Server
            let retries = 15; 
            
            while (retries > 0) {
                try {
                    // Gọi API (thêm t=... để chống cache trình duyệt)
                    const res = await fetch('/api/check-result?t=' + Date.now(), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ code: examCode, name: sName, studentId: sId })
                    });
                    const data = await res.json();

                    if (data.success && data.results.length > 0) {
                        // Sắp xếp: Mới nhất lên đầu
                        data.results.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                        
                        const latestFromServer = data.results[0];

                        // --- [KHẮC PHỤC TẠI ĐÂY] ---
                        // KHÔNG DÙNG IF (isNewer) NỮA!
                        // Cứ có dữ liệu là LƯU và VẼ LẠI hết!
                        
                        // 1. Lưu vào Session
                        sessionStorage.setItem('examResult', JSON.stringify(latestFromServer));
                        sessionStorage.setItem('examHistory', JSON.stringify(data.results));
                        
                        // 2. Cập nhật Hộp to
                        renderScore(latestFromServer);

                        // 3. Cập nhật Danh sách (BẮT BUỘC CHẠY)
                        renderHistoryTable(data.results);
                        
                        console.log("Đã đồng bộ dữ liệu: ", data.results.length, "bản ghi.");

                        // Nếu bài mới nhất khớp với bài vừa nộp (trong vòng 30s) thì dừng vòng lặp
                        const now = Date.now();
                        const submitTime = new Date(latestFromServer.submittedAt).getTime();
                        if (now - submitTime < 30000) {
                            return; // Đã thấy bài mới nhất -> Dừng, không spam server nữa
                        }
                    }
                } catch (e) { console.log("Đang đồng bộ..."); }

                retries--;
                await new Promise(r => setTimeout(r, 1000)); // Đợi 1 giây rồi quét lại
            }
        }

        function renderScore(data) {
            if(!data) return;
            document.getElementById('display-score').innerText = data.score;
            document.getElementById('res-name').innerText = data.studentName;
            document.getElementById('res-class').innerText = data.studentClass || '---';
            document.getElementById('res-id').innerText = data.studentId || '---';
            document.getElementById('res-code').innerText = data.examCode;
            
            const date = data.submittedAt ? new Date(data.submittedAt) : new Date();
            document.getElementById('res-time').innerText = date.toLocaleString('vi-VN');
            
            const scoreEl = document.getElementById('display-score');
            if(data.score < 5) scoreEl.style.color = '#dc3545';
            else if(data.score >= 8) scoreEl.style.color = '#198754';
            else scoreEl.style.color = '#4361ee';
        }

        function renderHistoryTable(list) {
            // Kiểm tra an toàn
            if (!list || list.length === 0) return;

            const section = document.getElementById('history-section');
            const tbody = document.getElementById('history-table-body');
            
            // Hiện bảng
            section.classList.remove('d-none'); 
            tbody.innerHTML = ''; 

            list.forEach((item, index) => {
                // Số thứ tự: Lấy tổng trừ index
                const attemptNum = list.length - index; 
                const date = new Date(item.submittedAt).toLocaleString('vi-VN');
                
                let statusBadge = '<span class="badge bg-success bg-opacity-10 text-success px-3">An toàn</span>';
                if(item.violations && item.violations.length > 0) {
                    statusBadge = `<span class="badge bg-danger bg-opacity-10 text-danger px-3" title="${item.violations.length} lỗi">${item.violations.length} Vi phạm</span>`;
                }

                // Highlight dòng đầu tiên (Mới nhất)
                // Thêm hiệu ứng nhấp nháy nhẹ nếu muốn
                const activeClass = (index === 0) ? "table-active fw-bold border-start border-4 border-primary bg-primary bg-opacity-10" : "";

                const row = `
                    <tr class="${activeClass}">
                        <td class="ps-4 text-secondary">#${attemptNum}</td>
                        <td class="small text-dark">${date}</td>
                        <td class="text-center ${item.score >= 5 ? 'text-primary' : 'text-danger'}">${item.score}</td>
                        <td class="pe-4 text-end">${statusBadge}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Chạy ngay khi load trang
        initScore();
    </script>
</body>
</html>