<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Proctor - Phòng Thi</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body class="student-mode">

    <div id="cheat-overlay">
        <div class="bg-white text-danger p-5 rounded-4 shadow-lg text-center" style="max-width: 500px;">
            <div class="mb-3"><i class="fas fa-exclamation-triangle fa-3x animate__animated animate__flash"></i></div>
            <h2 class="fw-bold">CẢNH BÁO VI PHẠM</h2>
            <p class="fs-5 mt-3 text-dark fw-bold" id="violation-reason">Phát hiện gian lận!</p>
            <hr>
            <p class="text-muted">Hệ thống sẽ tự động nộp bài sau:</p>
            <div class="cheat-timer" id="cheat-countdown">60</div>
            <button class="btn btn-danger w-100 fw-bold py-3 rounded-pill shadow-sm" onclick="CheatMonitor.resolve()">
                TÔI ĐÃ HIỂU, QUAY LẠI LÀM BÀI
            </button>
        </div>
    </div>

    <nav class="glass-header sticky-top bg-white border-bottom shadow-sm">
        <div class="container d-flex justify-content-between align-items-center py-2">
            <a href="#" class="brand-logo text-decoration-none fw-bold text-primary fs-4">
                <i class="fas fa-rocket me-2"></i> Smart Proctor
            </a>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-md-block">
                    <div class="fw-bold text-dark" id="student-name">...</div>
                    <small class="text-muted">Thí sinh</small>
                </div>
                <div class="timer-badge bg-danger text-white px-3 py-1 rounded-pill fw-bold">
                    <i class="fas fa-clock me-1"></i> <span id="exam-timer">00:00</span>
                </div>
            </div>
        </div>
    </nav>
    <div id="forced-submit-overlay" class="d-none">
        <div class="bg-white p-5 rounded-4 shadow-lg text-center animate__animated animate__fadeInDown" style="max-width: 600px; width: 90%;">
            <div class="mb-3 text-danger">
                <i class="fas fa-times-circle fa-4x"></i>
            </div>
            <h3 class="fw-bold text-dark">BÀI THI ĐÃ KẾT THÚC</h3>
            
            <div class="alert alert-danger mt-3 fw-bold" id="forced-reason">
                </div>

            <p class="text-secondary small mb-4">
                Hệ thống đã tự động thu bài làm của bạn.<br>
                Nếu bạn cho rằng đây là sự nhầm lẫn, hãy gửi kháng nghị ngay.
            </p>

            <div class="d-grid gap-2">
                <button class="btn btn-warning fw-bold py-3 rounded-pill shadow-sm" onclick="ExamController.openAppealForm()">
                    <i class="fas fa-gavel me-2"></i> GỬI KHÁNG NGHỊ
                </button>
                <a href="index.html" class="btn btn-light fw-bold py-2 rounded-pill text-muted">
                    <i class="fas fa-home me-2"></i> Về trang chủ
                </a>
            </div>
        </div>
    </div>

    <style>
        #forced-submit-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        #forced-submit-overlay.d-none { display: none !important; }

        /* [THÊM ĐOẠN NÀY] Đẩy bảng SweetAlert lên trên lớp phủ đen */
        div:where(.swal2-container) {
            z-index: 20000 !important;
        }
    </style>
    <div class="container exam-wrapper mt-4">
        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="nav-box mb-4 d-flex justify-content-between align-items-center p-2 bg-white rounded shadow-sm">
                    <button class="nav-control-btn" id="btn-prev" onclick="ExamController.prev()">
                        <i class="fas fa-chevron-left"></i> Trước
                    </button>
                    <div class="nav-center d-flex gap-2 overflow-auto px-3" id="nav-numbers"></div>
                    <button class="nav-control-btn btn-next" id="btn-next" onclick="ExamController.next()">
                        Tiếp <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div class="question-card p-4 bg-white rounded shadow-sm h-100 position-relative">
                    <div class="d-flex justify-content-between mb-3">
                        <span class="badge bg-primary px-3 py-2 rounded-pill">Câu <span id="q-idx">1</span></span>
                        <span class="text-muted small"><i class="fas fa-info-circle"></i> Chọn 1 đáp án đúng</span>
                    </div>
                    <h4 class="fw-bold mb-4" id="q-content" style="line-height: 1.5;">Đang tải...</h4>
                    <div class="options-list d-flex flex-column gap-3" id="options-container"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="camera-card bg-white p-3 rounded shadow-sm sticky-top" style="top: 90px; z-index: 100;">
                    <h6 class="fw-bold text-secondary mb-3 border-bottom pb-2">
                        <i class="fas fa-robot me-2"></i> AI Giám Sát
                    </h6>
                    
                    <div class="camera-wrapper">
                        <video class="input_video" autoplay playsinline muted></video>
                        <canvas class="output_canvas"></canvas>
                        <div id="ai-loading" class="ai-loading-overlay">
                            <div class="spinner-border text-light mb-2" role="status"></div>
                            <div class="small text-center">Khởi động AI...</div>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-light rounded-3 text-center border">
                        <div id="gesture-status" class="fw-bold fs-5 text-primary">Sẵn sàng</div>
                        <small class="text-muted d-block mt-1">Giữ ngón tay 0.5s để chốt</small>
                    </div>

                    <div class="alert alert-warning mt-3 mb-0 small text-start shadow-sm border-danger border-start border-4">
                        <div class="fw-bold text-danger mb-2 text-uppercase">
                            <i class="fas fa-exclamation-triangle me-1"></i> Các hành vi bị cấm:
                        </div>
                        <ul class="mb-3 ps-3 text-secondary" style="line-height: 1.6;">
                            <li><strong>Góc mặt:</strong> Quay ngang, cúi gằm, ngước lên.</li>
                            <li><strong>Nhận diện:</strong> Người lạ thi hộ (Sai FaceID).</li>
                            <li><strong>Thiết bị:</strong> Cầm điện thoại, đeo tai nghe.</li>
                            <li><strong>Hệ thống:</strong> Rời tab thi, mất kết nối Camera.</li>
                        </ul>
                        
                        <div class="bg-white p-2 rounded border border-danger border-opacity-25">
                            <div class="fw-bold text-danger mb-1">
                                <i class="fas fa-gavel me-1"></i> HẬU QUẢ:
                            </div>
                            <p class="mb-0 text-dark fw-bold" style="font-size: 0.9em;">
                                Hệ thống sẽ đếm ngược 60s phạt và <span class="text-danger text-uppercase">TỰ ĐỘNG NỘP BÀI</span>!
                            </p>
                        </div>
                    </div>

                    <button onclick="ExamController.submit(false)" class="btn btn-danger w-100 mt-3 fw-bold py-2 shadow-sm">
                        <i class="fas fa-paper-plane me-2"></i> NỘP BÀI THI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src="../js/exam-logic.js"></script>
</body>
</html>